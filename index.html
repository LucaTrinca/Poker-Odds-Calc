<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Odds Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Felt Texture */
        .poker-felt {
            background-color: #0f4d19;
            background-image: radial-gradient(rgba(255,255,255,0.1) 2px, transparent 2px);
            background-size: 30px 30px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }
        /* Custom Scrollbar for picker */
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        /* Animation for Selected Slot */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px #eab308; border-color: #eab308; }
            50% { box-shadow: 0 0 25px #eab308; border-color: #facc15; }
        }
        .selected-slot {
            animation: pulse-glow 1.5s infinite;
            transform: scale(1.1);
            z-index: 20;
        }
    </style>
</head>
<body class="bg-neutral-900 text-white h-screen flex flex-col overflow-hidden font-sans select-none">

    <div class="h-16 flex items-center justify-between px-4 sm:px-8 z-10 bg-neutral-900 shadow-md shrink-0 border-b border-white/5">
        
        <div class="w-24"></div>

        <div class="flex flex-col items-center">
            <h1 class="text-xl sm:text-2xl font-black text-yellow-500 tracking-wider text-center">POKER ODDS CALCULATOR</h1>
            <p class="text-neutral-500 text-[10px] sm:text-xs tracking-widest uppercase">By Luca Trinca</p>
        </div>

        <button onclick="resetTable()" class="w-24 text-xs font-bold text-red-500 hover:text-white border border-red-900/50 hover:bg-red-600 rounded px-3 py-2 transition uppercase tracking-wider">
            Reset
        </button>
    </div>

    <div class="flex-1 relative flex items-center justify-center overflow-hidden bg-neutral-900" onclick="deselectAll()">
        
        <div onclick="event.stopPropagation()" 
             class="relative w-[340px] h-[340px] sm:w-[600px] sm:h-[600px] md:w-[850px] md:h-[480px] rounded-[200px] border-[16px] border-amber-900 shadow-2xl poker-felt flex items-center justify-center transition-all duration-300 transform scale-90 sm:scale-100">
            
            <div class="flex gap-2 p-3 bg-black/30 rounded-2xl border border-white/5 backdrop-blur-sm shadow-inner" id="board-container">
                </div>

            <div id="players-container" class="absolute inset-0 pointer-events-none">
                </div>
        </div>
    </div>

    <div class="h-[35vh] sm:h-[280px] bg-neutral-950 border-t border-neutral-800 flex flex-col shrink-0 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        
        <div class="flex justify-between items-center px-4 py-2 bg-neutral-900 border-b border-neutral-800">
            <span class="text-sm font-bold text-neutral-400" id="picker-status">Select a card slot above...</span>
            <button onclick="clearSelectedSlot()" class="px-4 py-1 bg-neutral-800 text-neutral-400 text-xs rounded border border-neutral-700 hover:bg-neutral-700 hover:text-white transition">Clear Slot</button>
        </div>

        <div class="flex-1 overflow-y-auto p-2 sm:p-4 space-y-2" onclick="event.stopPropagation()">
            <div class="flex items-center gap-2">
                <div class="w-8 text-2xl text-center text-neutral-500">♠</div>
                <div class="flex gap-1 overflow-x-auto pb-2 scrollbar-hide" id="row-s"></div>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-8 text-2xl text-red-800">♥</div>
                <div class="flex gap-1 overflow-x-auto pb-2 scrollbar-hide" id="row-h"></div>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-8 text-2xl text-neutral-500">♣</div>
                <div class="flex gap-1 overflow-x-auto pb-2 scrollbar-hide" id="row-c"></div>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-8 text-2xl text-red-800">♦</div>
                <div class="flex gap-1 overflow-x-auto pb-2 scrollbar-hide" id="row-d"></div>
            </div>
        </div>
    </div>

    <script src="poker.js"></script>

    <script>
        // --- CONFIG ---
        const RANKS = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
        const SUITS = ['s', 'h', 'c', 'd'];
        const SUIT_ICONS = {'s':'♠', 'h':'♥', 'd':'♦', 'c':'♣'};
        
        // --- STATE ---
        let pokerModule = null;
        let players = Array(8).fill(null).map((_, i) => ({
            id: i,
            active: i < 2, 
            cards: [null, null],
            stats: { win: 0, tie: 0, equity: 0 }
        }));
        let board = [null, null, null, null, null];
        
        // Selection State
        let selection = { type: null, index: null, playerId: null }; 

        // --- INIT ---
        createPokerModule().then(mod => {
            pokerModule = mod;
            console.log("♠️ Engine Loaded");
            renderApp();
        });

        // --- CORE RENDER ---
        function renderApp() {
            renderBoard();
            renderPlayers();
            renderPicker();
        }

        function renderBoard() {
            const el = document.getElementById('board-container');
            el.innerHTML = board.map((card, i) => {
                const isSelected = selection.type === 'board' && selection.index === i;
                return `
                <div onclick="selectSlot(event, 'board', ${i})" 
                     class="w-10 h-14 sm:w-14 sm:h-20 rounded cursor-pointer flex items-center justify-center text-lg font-bold transition-all border-2 
                     ${getCardStyles(card)} 
                     ${isSelected ? 'selected-slot' : 'border-transparent shadow-md hover:translate-y-[-2px]'}">
                    ${formatCard(card)}
                </div>`;
            }).join('');
        }

        function renderPlayers() {
            const el = document.getElementById('players-container');
            el.innerHTML = players.map((p, i) => {
                const angle = (i * 45 + 90) * (Math.PI / 180);
                const rx = 52; 
                const ry = 58;
                const left = 50 + rx * Math.cos(angle);
                const top = 46 + ry * Math.sin(angle);

                const isActive = p.active || (p.cards[0] || p.cards[1]); 
                const opacity = isActive ? 'opacity-100 scale-100' : 'opacity-40 scale-90 grayscale';
                const glow = selection.playerId === i ? 'ring-2 ring-yellow-500' : '';

                return `
                <div class="absolute pointer-events-auto flex flex-col items-center transition-all duration-300 ${opacity}" 
                     style="left: ${left}%; top: ${top}%; transform: translate(-50%, -50%)">
                    
                    <div onclick="togglePlayer(${i})" 
                         class="w-10 h-10 sm:w-12 sm:h-12 bg-neutral-800 border-2 border-neutral-600 rounded-full flex items-center justify-center font-bold mb-2 cursor-pointer hover:bg-neutral-700 hover:border-yellow-500 transition text-xs sm:text-base ${glow}">
                        P${i+1}
                    </div>

                    <div class="flex gap-1">
                        ${renderPlayerCard(p, 0)}
                        ${renderPlayerCard(p, 1)}
                    </div>

                    <div class="mt-1 ${p.stats.equity > 0 ? 'opacity-100' : 'opacity-0'} transition-opacity duration-300">
                        <div class="bg-black/80 p-1.5 rounded border border-white/10 backdrop-blur-md flex gap-3 text-[9px] sm:text-[10px] font-mono shadow-lg">
                            <div class="flex flex-col items-center">
                                <span class="text-neutral-500 text-[8px] uppercase tracking-wider">Win</span>
                                <span class="text-green-400 font-bold">${p.stats.win}%</span>
                            </div>
                            <div class="flex flex-col items-center border-l border-white/10 pl-2">
                                <span class="text-neutral-500 text-[8px] uppercase tracking-wider">Tie</span>
                                <span class="text-blue-300 font-bold">${p.stats.tie}%</span>
                            </div>
                            <div class="flex flex-col items-center border-l border-white/10 pl-2">
                                <span class="text-neutral-500 text-[8px] uppercase tracking-wider">Eq</span>
                                <span class="text-yellow-400 font-bold">${p.stats.equity}%</span>
                            </div>
                        </div>
                    </div>

                </div>`;
            }).join('');
        }

        function renderPlayerCard(player, cardIndex) {
            const card = player.cards[cardIndex];
            const isSelected = selection.type === 'player' && selection.playerId === player.id && selection.index === cardIndex;
            return `
            <div onclick="selectSlot(event, 'player', ${cardIndex}, ${player.id})" 
                 class="w-9 h-12 sm:w-10 sm:h-14 rounded border-2 flex items-center justify-center text-sm font-bold cursor-pointer transition-all
                 ${getCardStyles(card)}
                 ${isSelected ? 'selected-slot' : 'border-gray-400/20 hover:border-white/50'}">
                ${formatCard(card)}
            </div>`;
        }

        function renderPicker() {
            const used = new Set();
            board.forEach(c => c && used.add(c));
            players.forEach(p => p.cards.forEach(c => c && used.add(c)));

            SUITS.forEach(suit => {
                const row = document.getElementById(`row-${suit}`);
                const isRed = suit === 'h' || suit === 'd';
                
                row.innerHTML = RANKS.map(rank => {
                    const card = `${rank}${suit}`;
                    const isUsed = used.has(card);
                    
                    return `
                    <button onclick="pickCard('${card}')" ${isUsed ? 'disabled' : ''}
                        class="w-8 h-12 sm:w-10 sm:h-14 shrink-0 rounded border flex items-center justify-center font-bold text-sm sm:text-lg transition-all duration-100
                        ${isUsed 
                            ? 'bg-neutral-800 border-neutral-700 text-neutral-600 opacity-30 cursor-not-allowed' 
                            : `bg-white border-neutral-300 hover:scale-110 active:scale-95 shadow-sm ${isRed ? 'text-red-600' : 'text-black'}`
                        }">
                        ${rank}${SUIT_ICONS[suit]}
                    </button>`;
                }).join('');
            });

            const status = document.getElementById('picker-status');
            if (selection.type) {
                const target = selection.type === 'board' ? `Board Card ${selection.index + 1}` : `Player ${selection.playerId + 1} Card ${selection.index + 1}`;
                status.innerText = `Picking for: ${target}`;
                status.className = "text-sm font-bold text-yellow-500 animate-pulse";
            } else {
                status.innerText = "Select a card slot above to begin...";
                status.className = "text-sm font-bold text-neutral-500";
            }
        }

        // --- INTERACTIONS ---

        function selectSlot(e, type, index, playerId = null) {
            e.stopPropagation(); 
            if (selection.type === type && selection.index === index && selection.playerId === playerId) {
                deselectAll();
            } else {
                selection = { type, index, playerId };
                renderApp();
            }
        }

        function pickCard(card) {
            if (!selection.type) return;

            if (selection.type === 'board') {
                board[selection.index] = card;
                if (selection.index < 4) selection.index++;
                else deselectAll();

            } else if (selection.type === 'player') {
                players[selection.playerId].active = true;
                players[selection.playerId].cards[selection.index] = card;
                if (selection.index === 0) selection.index = 1;
                else deselectAll();
            }
            
            calculate(); 
            renderApp();
        }

        function clearSelectedSlot() {
            if (!selection.type) return;
            if (selection.type === 'board') board[selection.index] = null;
            else players[selection.playerId].cards[selection.index] = null;
            
            calculate();
            renderApp();
        }

        function deselectAll() {
            selection = { type: null, index: null, playerId: null };
            renderApp();
        }

        function resetTable() {
            board = [null, null, null, null, null];
            players.forEach(p => {
                p.cards = [null, null];
                p.stats = { win: 0, tie: 0, equity: 0 };
                p.active = p.id < 2; 
            });
            deselectAll();
            calculate();
        }

        function togglePlayer(id) {
            const p = players[id];
            if (p.cards[0] || p.cards[1]) return; 
            
            p.active = !p.active;
            if (!p.active) p.stats = { win: 0, tie: 0, equity: 0 };
            
            calculate();
            renderApp();
        }

        // --- STYLES ---
        function getCardStyles(card) {
            if (!card) return 'bg-white/5 border-white/10 text-white/10';
            const isRed = card[1] === 'h' || card[1] === 'd';
            return `bg-white ${isRed ? 'text-red-600 border-red-200' : 'text-black border-gray-200'}`;
        }
        function formatCard(card) {
            if (!card) return '+';
            return `${card[0]}${SUIT_ICONS[card[1]]}`;
        }

        // --- ENGINE BRIDGE ---
        function calculate() {
            if (!pokerModule) return;

            const activePlayers = players.filter(p => p.active && p.cards[0] && p.cards[1]);
            const num = activePlayers.length;

            if (num < 2) {
                players.forEach(p => p.stats = {win:0, tie:0, equity:0});
                renderPlayers();
                return;
            }

            const handStrings = activePlayers.map(p => `${p.cards[0]} ${p.cards[1]}`);
            const boardString = board.filter(c => c).join(" ");

            const ptrHands = pokerModule._malloc(num * 4);
            const ptrsToFree = [ptrHands];

            handStrings.forEach((str, i) => {
                const ptr = pokerModule.stringToNewUTF8(str);
                ptrsToFree.push(ptr);
                pokerModule.setValue(ptrHands + (i*4), ptr, 'i32');
            });

            const ptrBoard = pokerModule.stringToNewUTF8(boardString);
            ptrsToFree.push(ptrBoard);

            const ptrResults = pokerModule._malloc(num * 32);
            ptrsToFree.push(ptrResults);

            pokerModule._calculate_equity(num, ptrHands, ptrBoard, ptrResults);

            activePlayers.forEach((p, i) => {
                const off = ptrResults + (i*32);
                const target = players.find(orig => orig.id === p.id);
                target.stats.win = pokerModule.getValue(off, 'double').toFixed(1);
                target.stats.tie = pokerModule.getValue(off+8, 'double').toFixed(1);
                target.stats.equity = pokerModule.getValue(off+24, 'double').toFixed(1);
            });

            ptrsToFree.forEach(p => pokerModule._free(p));
        }
    </script>
</body>
</html>
