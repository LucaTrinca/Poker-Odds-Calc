<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monolith Casino Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Felt Texture */
        .poker-felt {
            background-color: #0f4d19;
            background-image: radial-gradient(rgba(255,255,255,0.1) 2px, transparent 2px);
            background-size: 30px 30px;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
        }
        .card-slot:hover { transform: translateY(-4px); }
    </style>
</head>
<body class="bg-neutral-900 text-white min-h-screen flex flex-col items-center justify-center p-4 select-none font-sans">

    <div class="absolute top-8 text-center">
        <h1 class="text-4xl font-black text-yellow-500 tracking-wider drop-shadow-lg">MONOLITH</h1>
        <p class="text-neutral-500 text-sm">C-POWERED SOLVER</p>
    </div>

    <div class="relative w-[350px] h-[350px] sm:w-[600px] sm:h-[600px] md:w-[900px] md:h-[500px] rounded-[200px] border-[16px] border-amber-900 shadow-2xl poker-felt flex items-center justify-center mt-10">
        
        <div class="flex gap-2 p-4 bg-black/20 rounded-2xl border border-white/5 backdrop-blur-sm" id="board-container">
            </div>

        <div id="players-container" class="absolute inset-0 pointer-events-none">
            </div>

    </div>

    <button onclick="calculate()" class="mt-16 px-12 py-4 bg-gradient-to-b from-yellow-500 to-yellow-700 text-black font-black text-xl rounded-full shadow-[0_0_30px_rgba(234,179,8,0.4)] hover:scale-105 hover:shadow-[0_0_50px_rgba(234,179,8,0.6)] transition-all border-2 border-yellow-400 active:scale-95">
        RUN SIMULATION
    </button>

    <div id="modal-overlay" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal()">
        <div class="bg-neutral-800 border border-neutral-600 rounded-2xl p-6 max-w-4xl w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-yellow-500">Select Card</h2>
                <button onclick="closeModal()" class="text-neutral-400 hover:text-white text-xl">✕</button>
            </div>
            
            <div class="grid grid-cols-4 sm:grid-cols-13 gap-2" id="picker-grid">
                </div>
            
            <button onclick="selectCard(null)" class="mt-6 w-full py-3 bg-red-900/50 hover:bg-red-900 text-red-200 border border-red-800 rounded-lg transition font-bold">
                Clear Slot
            </button>
        </div>
    </div>

    <script src="poker.js"></script>

    <script>
        // --- GAME STATE ---
        let pokerModule = null;
        const RANKS = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
        const SUITS = ['s', 'h', 'd', 'c'];
        
        // 8 Players (2 active by default)
        let players = Array(8).fill(null).map((_, i) => ({
            id: i,
            active: i < 2, 
            cards: [null, null],
            stats: { win: 0, tie: 0, equity: 0 }
        }));
        let board = [null, null, null, null, null];
        
        // Picker State
        let pickerTarget = { type: null, index: 0, playerId: 0 }; 

        // --- INITIALIZATION ---
        createPokerModule().then(mod => {
            pokerModule = mod;
            console.log("♠️ C Engine Ready");
            renderApp();
        });

        // --- RENDER LOGIC ---
        function renderApp() {
            renderBoard();
            renderPlayers();
        }

        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = board.map((card, i) => `
                <div onclick="openPicker('board', ${i}, null)" 
                     class="card-slot w-10 h-14 sm:w-14 sm:h-20 rounded cursor-pointer flex items-center justify-center text-lg font-bold shadow-md transition-all border ${getCardStyles(card)}">
                    ${formatCard(card)}
                </div>
            `).join('');
        }

        function renderPlayers() {
            const container = document.getElementById('players-container');
            container.innerHTML = players.map((p, i) => {
                // Elliptical Positioning Logic
                const angle = (i * 45 + 90) * (Math.PI / 180); // Rotate to start at bottom
                // Radii (Percentage based to be responsive)
                const rx = 52; 
                const ry = 58;
                
                const left = 50 + rx * Math.cos(angle);
                const top = 46 + ry * Math.sin(angle);

                const opacity = p.active ? 'opacity-100 scale-100' : 'opacity-40 scale-75 grayscale';
                const glow = p.active ? 'shadow-[0_0_15px_rgba(0,0,0,0.5)]' : '';

                return `
                <div class="absolute pointer-events-auto flex flex-col items-center transition-all duration-300 ${opacity}" 
                     style="left: ${left}%; top: ${top}%; transform: translate(-50%, -50%)">
                    
                    <div onclick="togglePlayer(${i})" 
                         class="w-12 h-12 bg-neutral-800 border-2 border-neutral-600 rounded-full flex items-center justify-center font-bold mb-2 cursor-pointer hover:bg-neutral-700 hover:border-yellow-500 transition ${glow}">
                        P${i+1}
                    </div>

                    <div class="flex gap-1">
                        <div onclick="openPicker('player', 0, ${i})" class="card-slot w-10 h-14 bg-white rounded border border-gray-300 flex items-center justify-center text-sm font-bold cursor-pointer ${getCardStyles(p.cards[0])}">
                            ${formatCard(p.cards[0])}
                        </div>
                        <div onclick="openPicker('player', 1, ${i})" class="card-slot w-10 h-14 bg-white rounded border border-gray-300 flex items-center justify-center text-sm font-bold cursor-pointer ${getCardStyles(p.cards[1])}">
                            ${formatCard(p.cards[1])}
                        </div>
                    </div>

                    <div class="mt-1 text-xs bg-black/80 px-2 py-0.5 rounded text-yellow-400 font-mono ${p.stats.equity > 0 ? 'opacity-100' : 'opacity-0'}">
                        ${p.stats.equity}%
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- HELPERS ---
        function getCardStyles(card) {
            if (!card) return 'bg-white/10 border-white/10 text-white/20'; // Empty
            const suit = card[1];
            const isRed = suit === 'h' || suit === 'd';
            return `bg-white ${isRed ? 'text-red-600' : 'text-black'}`;
        }

        function formatCard(card) {
            if (!card) return '+';
            const suits = {'s':'♠', 'h':'♥', 'd':'♦', 'c':'♣'};
            return `${card[0]}${suits[card[1]]}`;
        }

        function togglePlayer(id) {
            players[id].active = !players[id].active;
            renderApp();
        }

        // --- MODAL LOGIC ---
        function openPicker(type, index, playerId) {
            // Only allow picking for active players
            if (type === 'player' && !players[playerId].active) return;

            pickerTarget = { type, index, playerId };
            const modal = document.getElementById('modal-overlay');
            const grid = document.getElementById('picker-grid');
            
            // Build Used Cards Set
            const used = new Set();
            board.forEach(c => c && used.add(c));
            players.forEach(p => p.cards.forEach(c => c && used.add(c)));

            // Render 52 Cards
            grid.innerHTML = SUITS.map(suit => 
                RANKS.map(rank => {
                    const card = `${rank}${suit}`;
                    const isUsed = used.has(card);
                    const isRed = suit === 'h' || suit === 'd';
                    const suits = {'s':'♠', 'h':'♥', 'd':'♦', 'c':'♣'};
                    
                    return `
                    <button onclick="selectCard('${card}')" ${isUsed ? 'disabled' : ''}
                        class="h-12 rounded border flex items-center justify-center font-bold text-lg transition
                        ${isUsed 
                            ? 'bg-neutral-900 border-neutral-800 text-neutral-700 opacity-50' 
                            : `bg-white hover:scale-110 hover:shadow-glow hover:z-10 ${isRed ? 'text-red-600' : 'text-black'}`
                        }">
                        ${rank}${suits[suit]}
                    </button>`;
                }).join('')
            ).join('');

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function selectCard(card) {
            if (pickerTarget.type === 'board') {
                board[pickerTarget.index] = card;
            } else {
                players[pickerTarget.playerId].cards[pickerTarget.index] = card;
            }
            closeModal();
            renderApp();
        }

        // --- WASM BRIDGE ---
        function calculate() {
            if (!pokerModule) return;

            // 1. Prepare Data
            const activePlayers = players.filter(p => p.active && p.cards[0] && p.cards[1]);
            const num = activePlayers.length;
            if (num < 2) return alert("Need at least 2 active players with full hands!");

            const handStrings = activePlayers.map(p => `${p.cards[0]} ${p.cards[1]}`);
            const boardString = board.filter(c => c).join(" "); // "As Ks"

            // 2. Allocate Memory
            const ptrHands = pokerModule._malloc(num * 4);
            const ptrsToFree = [ptrHands];

            handStrings.forEach((str, i) => {
                const ptr = pokerModule.stringToNewUTF8(str);
                ptrsToFree.push(ptr);
                pokerModule.setValue(ptrHands + (i * 4), ptr, 'i32');
            });

            const ptrBoard = pokerModule.stringToNewUTF8(boardString);
            ptrsToFree.push(ptrBoard);

            const ptrResults = pokerModule._malloc(num * 32);
            ptrsToFree.push(ptrResults);

            // 3. Call C Engine
            pokerModule._calculate_equity(num, ptrHands, ptrBoard, ptrResults);

            // 4. Read Results & Update State
            activePlayers.forEach((p, i) => {
                const offset = ptrResults + (i * 32);
                // We update the original player object in the main array
                const targetPlayer = players.find(orig => orig.id === p.id);
                targetPlayer.stats.win = pokerModule.getValue(offset, 'double').toFixed(1);
                targetPlayer.stats.tie = pokerModule.getValue(offset+8, 'double').toFixed(1);
                targetPlayer.stats.equity = pokerModule.getValue(offset+24, 'double').toFixed(1);
            });

            // 5. Cleanup
            ptrsToFree.forEach(p => pokerModule._free(p));

            renderApp();
        }
    </script>
</body>
</html>
